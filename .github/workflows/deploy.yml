name: Deploy to EC2 with Dynamic Allow-list

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build with Gradle
        run: ./gradlew bootJar -x test

      # ---------------------------------------------------------
      # STEP A: Configure AWS Credentials
      # ---------------------------------------------------------
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # ---------------------------------------------------------
      # STEP B: Get GitHub Runner IP & Open Security Group
      # ---------------------------------------------------------
      - name: Whitelist Runner IP
        id: whitelist
        run: |
          # 1. Get current IP
          IP=$(curl -s https://checkip.amazonaws.com)
          echo "Runner IP is $IP"
          
          # 2. Add IP to Security Group (Port 22 only)
          aws ec2 authorize-security-group-ingress \
            --group-id ${{ secrets.AWS_SG_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr ${IP}/32
          
          # 3. Save IP to a variable so we can remove it later
          echo "RUNNER_IP=${IP}" >> $GITHUB_ENV

      # ---------------------------------------------------------
      # STEP C: Deploy (SCP & SSH)
      # ---------------------------------------------------------
      - name: Copy JAR to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          source: "build/libs/*.jar"
          target: "/home/ec2-user/app"
          strip_components: 2

      - name: Restart Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            # -------------------------------------------------------
            # 1. THE "ZOMBIE KILLER" (Check Port 8080 directly)
            # -------------------------------------------------------
            # Find the ID of whatever process is listening on Port 8080
            PORT_PID=$(lsof -t -i:8080 || true)
            
            if [ -z "$PORT_PID" ]; then
              echo "Port 8080 is free. No zombie server found."
            else
              echo "Found process $PORT_PID holding Port 8080. Killing it..."
              kill -9 $PORT_PID
              sleep 2
            fi
            
            # Double check: Remove old pid.txt just in case
            rm pid.txt || true
            
            # -------------------------------------------------------
            # 2. START NEW SERVER
            # -------------------------------------------------------
            nohup java -jar /home/ec2-user/app/pokemoncard.server-0.0.1-SNAPSHOT.jar \
              --spring.datasource.url=jdbc:postgresql://pokemon-db-prod.c3qewmi46ipv.ap-southeast-2.rds.amazonaws.com:5432/postgres \
              --spring.datasource.username=dbMaster \
              --spring.datasource.password=${{ secrets.PROD_DB_PASSWORD }} \
              > app.log 2>&1 < /dev/null &
            
            echo "New server started with PID: $!"
            echo $! > pid.txt
            
            # Allow start time
            sleep 2
            exit 0

      # ---------------------------------------------------------
      # STEP D: Revoke Access (Cleanup)
      # This runs "always()", even if the deployment fails!
      # ---------------------------------------------------------
      - name: Revoke Runner IP
        if: always()
        run: |
          aws ec2 revoke-security-group-ingress \
            --group-id ${{ secrets.AWS_SG_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr ${{ env.RUNNER_IP }}/32